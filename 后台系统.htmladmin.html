<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å©šç¤¼æŠ½å¥– - åå°ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --gold: #D4AF37;
            --gold-light: #F4E8C1;
            --navy: #1a1a2e;
            --cream: #FDF5E6;
            --rose: #E8D5D0;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            background: linear-gradient(135deg, #f5f0eb 0%, #e8e0d5 100%);
            min-height: 100vh;
            color: var(--navy);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            text-align: center;
            color: var(--navy);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            text-align: center;
            color: var(--gold);
            margin-bottom: 30px;
            font-size: 1.2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            border: 1px solid var(--gold-light);
        }

        h2 {
            font-family: 'Playfair Display', serif;
            color: var(--navy);
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--gold-light);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--navy);
        }

        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--gold) 0%, #B8941F 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--navy);
            border: 2px solid var(--gold);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--gold-light);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold);
            font-family: 'Playfair Display', serif;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .question-list {
            margin-top: 20px;
        }

        .question-item {
            background: white;
            border: 1px solid var(--gold-light);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-info {
            flex: 1;
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .question-answer {
            color: var(--gold);
            font-size: 0.9rem;
        }

        .delete-btn {
            background: #fee;
            color: #e74c3c;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #e74c3c;
            color: white;
        }

        .participants-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 10px;
        }

        .participant-tag {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid var(--gold-light);
            font-size: 0.9rem;
            position: relative;
        }

        .participant-tag.winner {
            background: var(--gold);
            color: white;
            border-color: var(--gold);
        }

        .links-section {
            background: linear-gradient(135deg, var(--navy) 0%, #2d2d44 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .links-section h2 {
            color: var(--gold);
            border-bottom-color: rgba(212, 175, 55, 0.3);
        }

        .link-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .link-url {
            font-family: monospace;
            color: var(--gold-light);
            word-break: break-all;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            z-index: 1000;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            background: #27ae60;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border-left: 4px solid var(--gold);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 3000;
        }

        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: #27ae60; }
        .toast.error { border-left-color: #e74c3c; }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .link-item { flex-direction: column; gap: 10px; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="sync-status">
        <div class="sync-dot"></div>
        <span>å®æ—¶åŒæ­¥ä¸­</span>
    </div>

    <div class="container">
        <h1>â¦ å©šç¤¼æŠ½å¥–ç®¡ç†ç³»ç»Ÿ</h1>
        <p class="subtitle">åå°æ§åˆ¶ä¸­å¿ƒ</p>

        <!-- é¡µé¢é“¾æ¥ -->
        <div class="links-section">
            <h2>é¡µé¢é“¾æ¥ï¼ˆè¯·ä¿å­˜è¿™äº›é“¾æ¥ï¼‰</h2>
            <div class="link-item">
                <div>
                    <strong>å®¾å®¢ç™»è®°é¡µé¢</strong><br>
                    <span class="link-url" id="guest-url"></span>
                </div>
                <button class="btn btn-secondary" onclick="copyLink('guest')">å¤åˆ¶é“¾æ¥</button>
            </div>
            <div class="link-item">
                <div>
                    <strong>æŠ½å¥–å±•ç¤ºé¡µé¢</strong><br>
                    <span class="link-url" id="display-url"></span>
                </div>
                <button class="btn btn-secondary" onclick="copyLink('display')">å¤åˆ¶é“¾æ¥</button>
            </div>
            <div class="link-item">
                <div>
                    <strong>å½“å‰åå°é¡µé¢</strong><br>
                    <span class="link-url" id="admin-url"></span>
                </div>
                <button class="btn btn-secondary" onclick="copyLink('admin')">å¤åˆ¶é“¾æ¥</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="stat-questions">0</div>
                <div class="stat-label">å·²è®¾é—®é¢˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-participants">0</div>
                <div class="stat-label">å·²ç™»è®°å®¾å®¢</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-eligible">0</div>
                <div class="stat-label">å¯æŠ½å¥–äººæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-winners">0</div>
                <div class="stat-label">å·²ä¸­å¥–äººæ•°</div>
            </div>
        </div>

        <!-- é—®é¢˜ç®¡ç† -->
        <div class="card">
            <h2>ğŸ“ é¢˜ç›®è®¾ç½®</h2>
            <div class="form-group">
                <label>é—®é¢˜å†…å®¹</label>
                <input type="text" id="q-text" placeholder="ä¾‹å¦‚ï¼šæ–°å¨˜æœ€å–œæ¬¢ä»€ä¹ˆé¢œè‰²ï¼Ÿ">
            </div>
            <div class="form-group">
                <label>æ­£ç¡®ç­”æ¡ˆ</label>
                <input type="text" id="q-answer" placeholder="ä¾‹å¦‚ï¼šè“è‰²">
            </div>
            <div class="form-group">
                <label>é€‰é¡¹ï¼ˆç”¨é€—å·åˆ†éš”ï¼ŒåŒ…å«æ­£ç¡®ç­”æ¡ˆï¼‰</label>
                <input type="text" id="q-options" placeholder="çº¢è‰²,è“è‰²,ç»¿è‰²,é»„è‰²">
            </div>
            <button class="btn" onclick="addQuestion()">æ·»åŠ é¢˜ç›®</button>
            
            <div class="question-list" id="question-list">
                <div class="empty-state">æš‚æ— é¢˜ç›®ï¼Œè¯·æ·»åŠ </div>
            </div>
        </div>

        <!-- å‚ä¸è€…ç®¡ç† -->
        <div class="card">
            <h2>ğŸ‘¥ å®¾å®¢åå•ç®¡ç†</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                <button class="btn btn-secondary" onclick="resetWinners()">é‡ç½®ä¸­å¥–è®°å½•</button>
            </div>
            <div class="participants-list" id="participants-list">
                <div class="empty-state" style="grid-column: 1/-1;">æš‚æ— å®¾å®¢ç™»è®°</div>
            </div>
        </div>

        <!-- æŠ½å¥–æ§åˆ¶ -->
        <div class="card">
            <h2>ğŸ° æŠ½å¥–æ§åˆ¶</h2>
            <div class="form-group">
                <label>æŠ½å–äººæ•°</label>
                <input type="number" id="draw-count" min="1" value="1" style="max-width: 200px;">
            </div>
            <button class="btn" onclick="startDraw()" style="font-size: 1.2rem; padding: 15px 40px;">
                âœ¦ å¼€å§‹æŠ½å¥– âœ¦
            </button>
            <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                æç¤ºï¼šæŠ½å¥–ç»“æœå°†å®æ—¶æ˜¾ç¤ºåœ¨æŠ½å¥–å±•ç¤ºé¡µé¢
            </p>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // æ•°æ®å­˜å‚¨
        const STORAGE_KEYS = {
            QUESTIONS: 'wedding_questions_v2',
            PARTICIPANTS: 'wedding_participants_v2',
            WINNERS: 'wedding_winners_v2',
            DRAWING: 'wedding_drawing_state',
            CURRENT_DRAW: 'wedding_current_draw'
        };

        let questions = [];
        let participants = [];
        let winners = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateUI();
            setupSync();
            generateLinks();
            
            // æ¯ç§’æ£€æŸ¥åŒæ­¥
            setInterval(checkSync, 1000);
        });

        function generateLinks() {
            const base = window.location.origin + window.location.pathname.replace('admin.html', '');
            document.getElementById('guest-url').textContent = base + 'guest.html';
            document.getElementById('display-url').textContent = base + 'display.html';
            document.getElementById('admin-url').textContent = base + 'admin.html';
        }

        function copyLink(type) {
            const base = window.location.origin + window.location.pathname.replace('admin.html', '');
            let url = '';
            if (type === 'guest') url = base + 'guest.html';
            else if (type === 'display') url = base + 'display.html';
            else url = base + 'admin.html';
            
            navigator.clipboard.writeText(url).then(() => {
                showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });
        }

        function loadData() {
            questions = JSON.parse(localStorage.getItem(STORAGE_KEYS.QUESTIONS)) || [];
            participants = JSON.parse(localStorage.getItem(STORAGE_KEYS.PARTICIPANTS)) || [];
            winners = JSON.parse(localStorage.getItem(STORAGE_KEYS.WINNERS)) || [];
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEYS.QUESTIONS, JSON.stringify(questions));
            localStorage.setItem(STORAGE_KEYS.PARTICIPANTS, JSON.stringify(participants));
            localStorage.setItem(STORAGE_KEYS.WINNERS, JSON.stringify(winners));
            // è§¦å‘åŒæ­¥äº‹ä»¶
            localStorage.setItem('wedding_sync_trigger', Date.now().toString());
        }

        function setupSync() {
            window.addEventListener('storage', function(e) {
                if (e.key === 'wedding_sync_trigger') {
                    loadData();
                    updateUI();
                }
            });
        }

        function checkSync() {
            loadData();
            updateUI();
        }

        function updateUI() {
            // æ›´æ–°ç»Ÿè®¡
            const eligible = participants.filter(p => p.answered && !winners.find(w => w.id === p.id));
            document.getElementById('stat-questions').textContent = questions.length;
            document.getElementById('stat-participants').textContent = participants.length;
            document.getElementById('stat-eligible').textContent = eligible.length;
            document.getElementById('stat-winners').textContent = winners.length;

            // æ›´æ–°é—®é¢˜åˆ—è¡¨
            const qList = document.getElementById('question-list');
            if (questions.length === 0) {
                qList.innerHTML = '<div class="empty-state">æš‚æ— é¢˜ç›®ï¼Œè¯·æ·»åŠ </div>';
            } else {
                qList.innerHTML = questions.map((q, i) => `
                    <div class="question-item">
                        <div class="question-info">
                            <div class="question-text">${i+1}. ${q.text}</div>
                            <div class="question-answer">ç­”æ¡ˆï¼š${q.answer} | é€‰é¡¹ï¼š${q.options.join(', ')}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteQuestion(${q.id})">Ã—</button>
                    </div>
                `).join('');
            }

            // æ›´æ–°å‚ä¸è€…åˆ—è¡¨
            const pList = document.getElementById('participants-list');
            if (participants.length === 0) {
                pList.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">æš‚æ— å®¾å®¢ç™»è®°</div>';
            } else {
                pList.innerHTML = participants.map(p => {
                    const isWinner = winners.find(w => w.id === p.id);
                    const status = p.answered ? (isWinner ? 'winner' : 'eligible') : 'pending';
                    const statusText = p.answered ? (isWinner ? 'å·²ä¸­å¥–' : 'å¯æŠ½å¥–') : 'å¾…ç­”é¢˜';
                    return `
                        <div class="participant-tag ${isWinner ? 'winner' : ''}">
                            <div style="font-weight: 600;">${p.name}</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">${statusText}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function addQuestion() {
            const text = document.getElementById('q-text').value.trim();
            const answer = document.getElementById('q-answer').value.trim();
            const optionsStr = document.getElementById('q-options').value.trim();

            if (!text || !answer) {
                showToast('è¯·å¡«å†™é—®é¢˜å’Œç­”æ¡ˆ', 'error');
                return;
            }

            let options = optionsStr ? optionsStr.split(',').map(s => s.trim()) : [answer];
            if (!options.includes(answer)) options.push(answer);
            options = options.sort(() => Math.random() - 0.5);

            questions.push({
                id: Date.now(),
                text: text,
                answer: answer,
                options: options
            });

            saveData();
            updateUI();
            
            document.getElementById('q-text').value = '';
            document.getElementById('q-answer').value = '';
            document.getElementById('q-options').value = '';
            showToast('é¢˜ç›®æ·»åŠ æˆåŠŸ', 'success');
        }

        function deleteQuestion(id) {
            questions = questions.filter(q => q.id !== id);
            saveData();
            updateUI();
            showToast('é¢˜ç›®å·²åˆ é™¤', 'success');
        }

        function startDraw() {
            const count = parseInt(document.getElementById('draw-count').value);
            const eligible = participants.filter(p => p.answered && !winners.find(w => w.id === p.id));
            
            if (eligible.length === 0) {
                showToast('æ²¡æœ‰å¯æŠ½å¥–çš„å®¾å®¢', 'error');
                return;
            }
            if (count > eligible.length) {
                showToast(`åªæœ‰ ${eligible.length} äººå¯æŠ½å¥–`, 'error');
                return;
            }

            // è®¾ç½®æŠ½å¥–çŠ¶æ€ï¼Œé€šçŸ¥å±•ç¤ºé¡µé¢å¼€å§‹åŠ¨ç”»
            localStorage.setItem(STORAGE_KEYS.DRAWING, 'true');
            localStorage.setItem(STORAGE_KEYS.CURRENT_DRAW, JSON.stringify({
                count: count,
                startTime: Date.now()
            }));

            showToast('æŠ½å¥–å·²å¼€å§‹ï¼Œè¯·æŸ¥çœ‹å±•ç¤ºé¡µé¢', 'success');
            
            // 3ç§’åå…¬å¸ƒç»“æœ
            setTimeout(() => {
                const shuffled = [...eligible].sort(() => Math.random() - 0.5);
                const selected = shuffled.slice(0, count);
                
                selected.forEach(w => winners.push(w));
                saveData();
                updateUI();
                
                localStorage.setItem(STORAGE_KEYS.DRAWING, 'false');
                localStorage.setItem(STORAGE_KEYS.CURRENT_DRAW, JSON.stringify({
                    count: count,
                    winners: selected,
                    finished: true,
                    finishTime: Date.now()
                }));
                
                showToast(`æŠ½å¥–å®Œæˆï¼${count}ä½å¹¸è¿å„¿å·²äº§ç”Ÿ`, 'success');
            }, 3000);
        }

        function resetWinners() {
            if (!confirm('ç¡®å®šè¦é‡ç½®ä¸­å¥–è®°å½•å—ï¼Ÿæ‰€æœ‰ä¸­å¥–æ•°æ®å°†è¢«æ¸…ç©ºã€‚')) return;
            winners = [];
            saveData();
            updateUI();
            showToast('ä¸­å¥–è®°å½•å·²é‡ç½®', 'success');
        }

        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            questions = [];
            participants = [];
            winners = [];
            localStorage.removeItem(STORAGE_KEYS.QUESTIONS);
            localStorage.removeItem(STORAGE_KEYS.PARTICIPANTS);
            localStorage.removeItem(STORAGE_KEYS.WINNERS);
            localStorage.removeItem(STORAGE_KEYS.DRAWING);
            localStorage.removeItem(STORAGE_KEYS.CURRENT_DRAW);
            updateUI();
            showToast('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
        }

        function exportData() {
            const data = {
                questions: questions,
                participants: participants,
                winners: winners,
                exportTime: new Date().toLocaleString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å©šç¤¼æŠ½å¥–æ•°æ®_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            showToast('æ•°æ®å·²å¯¼å‡º', 'success');
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>